<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anglican Churches in Jamaica — ArcGIS JS</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --muted: #64748b; --text: #e5e7eb; --accent: #93c5fd;
    }
    html, body, #viewDiv { height: 100%; width: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    .app { display: grid; grid-template-columns: 1fr 420px; grid-template-rows: 48px 1fr; height: 100%; }
    header { grid-column: 1 / -1; display:flex; align-items:center; gap:8px; padding:6px 10px; border-bottom: 1px solid #1f2937; }
    header h1 { margin:0; font-size:16px; font-weight:600; }
    header .spacer{flex:1}
    header input, header select, header button { background:#0b1220; border:1px solid #233044; color:var(--text); border-radius:8px; padding:6px 10px; }
    #viewDiv { grid-row: 2; grid-column: 1; }
    aside { grid-row: 2; grid-column: 2; background: var(--panel); border-left: 1px solid #1f2937; overflow:auto; }
    .pane { padding: 12px; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 12px; }
    .chip { background:#0b1220; border:1px solid #233044; padding:2px 10px; border-radius:999px; font-size:12px; color:#cbd5e1; }
    .section { margin-top: 14px; }
    .section h3 { margin:0 0 6px; font-size:14px; color: var(--accent); }
    .muted { color: var(--muted); font-size: 12px; }
    .gallery { display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; }
    .gallery img { width: 100%; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #233044; }

    .controlBar { position:absolute; top:64px; left:12px; z-index:10; background:#0b1220cc; padding:8px; border:1px solid #233044; border-radius:12px; backdrop-filter: blur(4px); }
    .controlBar label { display:block; font-size:12px; color:#cbd5e1; margin-top:6px; }
    .controlBar input, .controlBar select, .controlBar button { width: 220px; margin-top:4px; background:#0b1220; border:1px solid #233044; color:var(--text); border-radius:8px; padding:6px 10px; }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; grid-template-rows: 48px 300px 1fr; }
      #viewDiv { grid-row: 2; }
      aside { grid-row: 3; }
      .controlBar { top: 56px; left: 8px; right: 8px; width: calc(100% - 16px); }
      .controlBar input, .controlBar select, .controlBar button { width: 100%; }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Anglican Churches in Jamaica</h1>
    <div class="spacer"></div>
    <button id="loadCsvBtn" title="Load CSV">Load CSV</button>
    <input id="fileInput" type="file" accept=".csv" style="display:none" />
  </header>

  <div id="viewDiv"></div>

  <div class="controlBar">
    <label for="q">Search (name / alt / town / parish)</label>
    <input id="q" type="text" placeholder="e.g. Black River or St. Mark" />
    <label for="parishSel">Parish</label>
    <select id="parishSel"><option value="">All</option></select>
    <label for="statusSel">Status</label>
    <select id="statusSel"><option value="">All</option></select>
    <label for="classSel">Classification</label>
    <select id="classSel"><option value="">All</option></select>
    <button id="resetBtn" style="margin-top:8px">Reset filters</button>
  </div>

  <aside>
    <div class="pane" id="details">
      <h2 style="margin:0 0 6px">Welcome</h2>
      <div class="muted">Use the map, search, or filters to find a church. Click a marker to open details here.</div>
      <div class="section">
        <h3>Historical overview (brief)</h3>
        <div class="muted">
          Anglicanism took root after the English conquest of 1655, when the island’s parish system formed and the Church of England served as state church. The Diocese of Jamaica (1824) later joined the Church in the Province of the West Indies. After emancipation (1834/1838), missions expanded into rural districts with chapels-of-ease and schools. Through disestablishment and then Independence (1962), Anglican parishes preserved historic buildings while adapting worship, education, and social ministries to a modern Caribbean nation.
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
// ======== CONFIG ========
const ARCGIS_API_KEY = "AAPTxy8BH1VEsoebNVZXo8HurEMBve8Y5X5uLK0kZ_bs44aG89V9anGObvntUVtNR6i9wOsRtZ5pO_ltZj-fTRe48C5rIonuGmEJ4_9PbGuQ2y6uOGBHEXYS7DNPCjZcF_JCmErDoCv97dBP3tr9Ociii_hk8cqmBBXwr_WSuyU8mcOgHiDq-MVTa1xCyFqfgqk4jXyIu9SLX5RURDWVO7D4z2Oc2wmH1TG2te32HllSaR4.AT1_pUnmqJfX"; // TODO: set your key
const DEFAULT_CSV_URL = "./data/churches.csv"; // optional default

// ======== LOAD MODULES ========
require([
  "esri/config",
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/GeoJSONLayer",
  "esri/layers/support/FeatureReductionCluster",
  "esri/widgets/BasemapToggle",
  "esri/widgets/LayerList",
  "esri/widgets/Expand"
], (esriConfig, Map, MapView, GeoJSONLayer, FeatureReductionCluster, BasemapToggle, LayerList, Expand) => {
  esriConfig.apiKey = ARCGIS_API_KEY;

  const map = new Map({ basemap: "arcgis-imagery" }); // Imagery Hybrid (labels)
  const view = new MapView({ container: "viewDiv", map, center: [-77.3, 18.1], zoom: 9, constraints: {snapToZoom:false} });

  const basemapToggle = new BasemapToggle({ view, nextBasemap: "arcgis-streets" });
  view.ui.add(basemapToggle, "bottom-right");

  const layerList = new LayerList({ view });
  view.ui.add(new Expand({ view, content: layerList, expanded: false }), "top-right");

  // UI controls
  const $ = (id) => document.getElementById(id);
  $("loadCsvBtn").addEventListener("click", () => $("fileInput").click());
  $("fileInput").addEventListener("change", (e) => { const f=e.target.files[0]; if (f) loadCsvFile(f); });
  $("q").addEventListener("input", applyDefinitionExpression);
  $("parishSel").addEventListener("change", applyDefinitionExpression);
  $("statusSel").addEventListener("change", applyDefinitionExpression);
  $("classSel").addEventListener("change", applyDefinitionExpression);
  $("resetBtn").addEventListener("click", () => { $("q").value=""; $("parishSel").value=""; $("statusSel").value=""; $("classSel").value=""; applyDefinitionExpression(); });

  let layer = null; // GeoJSONLayer

  // Attempt to load default CSV
  // Attempt to load default CSV (fetch directly; show errors)
(async () => {
  try {
    const res = await fetch(DEFAULT_CSV_URL, { cache: "no-cache" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const txt = await res.text();
    buildFromCsv(txt);
    console.log(`[churches] loaded: ${DEFAULT_CSV_URL}`);
  } catch (e) {
    console.warn(`[churches] failed to load ${DEFAULT_CSV_URL}:`, e);
    // Optional: show a small hint so you know why filters are empty
    const hint = document.createElement("div");
    hint.className = "muted";
    hint.style.margin = "8px 0";
    hint.textContent = `Couldn’t auto-load ${DEFAULT_CSV_URL}. Use “Load CSV” or place it at that path.`;
    document.querySelector(".controlBar").appendChild(hint);
  }
})();


  async function fetchCsv(url){ const txt=await (await fetch(url)).text(); buildFromCsv(txt); }
  function loadCsvFile(file){ const reader=new FileReader(); reader.onload=(e)=>buildFromCsv(e.target.result); reader.readAsText(file); }

  function buildFromCsv(csvText){
    // Parse CSV (simple parser)
    const rows = csvToObjects(csvText);
    console.log(`[churches] parsed rows: ${rows.length}`);
    const feats = rowsToGeoJSON(rows);
    const blob = new Blob([JSON.stringify(feats)], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    if (layer) { map.remove(layer); layer.destroy(); layer=null; }

    layer = new GeoJSONLayer({
      url,
      title: "Anglican Churches",
      copyright: "© Anglican Churches Jamaica",
      popupEnabled: true,
      outFields: ["*"],
      featureReduction: new FeatureReductionCluster({ clusterRadius: "80px" }),
      renderer: {
        type: "simple",
        symbol: { type: "simple-marker", color: "#1d4ed8", outline: { color: "white", width: 0.5 }, size: 8 }
      },
      popupTemplate: {
        title: "{name}",
        content: popupContent,
        fieldInfos: [
          { fieldName: "parish", label: "Parish" },
          { fieldName: "town_village", label: "Town/Village" },
          { fieldName: "status", label: "Status" },
          { fieldName: "classification", label: "Classification" }
        ]
      }
    });

    map.add(layer);
    layer.when(() => {
      view.whenLayerView(layer).then(() => {
        // Build filter dropdowns
        const attrs = rows.map(r => ({ parish:r.parish, status:r.status, classification:r.classification }));
        fillSelect($("parishSel"), unique(attrs.map(a => a.parish).filter(Boolean)));
        fillSelect($("statusSel"), unique(attrs.map(a => a.status).filter(Boolean)));
        fillSelect($("classSel"), unique(attrs.map(a => a.classification).filter(Boolean)));
        applyDefinitionExpression();
      });
    });
  }

  function popupContent(feature){
    const g = feature.graphic; const a = g.attributes || {};
    const chips = [a.parish, a.status, a.classification].filter(Boolean).map(x=>`<span class="chip">${escapeHtml(x)}</span>`).join(" ");
    const imgs = (a.images||"").split(";").map(s=>s.trim()).filter(Boolean);
    const vids = (a.videos||"").split(";").map(s=>s.trim()).filter(Boolean);

    setDetails(a); // also mirror into side panel

    let html = `<div class="chips" style="margin:6px 0 8px">${chips}</div>`;
    if (a.summary) html += `<div style="margin-bottom:8px">${escapeHtml(a.summary)}</div>`;
    if (imgs.length) html += `<div class="gallery">${imgs.slice(0,3).map(src=>`<img src="${escapeAttr(src)}"/>`).join("")}</div>`;
    html += `<div style="margin-top:8px"><button onclick="window.__openDetails('${a.id||''}')">Open details →</button></div>`;
    return html;
  }

  // ====== Filtering via definitionExpression ======
  function applyDefinitionExpression(){
    if (!layer) return;
    const q = ($("q").value||"").toLowerCase();
    const parish = $("parishSel").value; const status=$("statusSel").value; const klass=$("classSel").value;

    const expressions = [];
    if (parish) expressions.push(`LOWER(parish) = '${sqlEscape(parish.toLowerCase())}'`);
    if (status) expressions.push(`LOWER(status) = '${sqlEscape(status.toLowerCase())}'`);
    if (klass)  expressions.push(`LOWER(classification) = '${sqlEscape(klass.toLowerCase())}'`);

    // Text search across multiple fields
    if (q) {
      const fields = ["name","alt_names","town_village","parish"];
      const likeParts = fields.map(f => `LOWER(${f}) LIKE '%${sqlEscape(q)}%'`);
      expressions.push(`(${likeParts.join(" OR ")})`);
    }

    layer.definitionExpression = expressions.join(" AND ");
  }

  // ====== Details side panel ======
  window.__openDetails = (id) => {
    if (!layer) return;
    // query by id
    layer.queryFeatures({ where: `id = '${sqlEscape(id)}'`, outFields: ["*"], returnGeometry: true }).then((res) => {
      const f = res.features?.[0]; if (!f) return;
      view.goTo({ target: f.geometry, zoom: Math.max(view.zoom, 12) }, { duration: 600 });
      setDetails(f.attributes || {});
    });
  };

  function setDetails(a){
    const el = document.getElementById("details");
    const chips = [a.parish, a.status, a.classification].filter(Boolean).map(x=>`<span class="chip">${escapeHtml(x)}</span>`).join(" ");
    const imgs = (a.images||"").split(";").map(s=>s.trim()).filter(Boolean);
    const vids = (a.videos||"").split(";").map(s=>s.trim()).filter(Boolean);

    el.innerHTML = `
      <h2 style="margin:0 0 4px">${escapeHtml(a.name || "")}</h2>
      <div class="muted">${escapeHtml(a.town_village||"")}${a.town_village?', ':''}${escapeHtml(a.parish||"")}</div>
      <div class="chips">${chips}</div>
      ${section('Summary', a.summary || placeholder('No summary yet.'))}
      ${section('History', md(a.history_md) || placeholder('No history added yet.'))}
      ${section('Architecture / Structure', md(a.architecture_md) || placeholder('No architecture/structure notes yet.'))}
      ${section('Worship & Clergy', md(a.worship_clergy_md) || placeholder('No worship & clergy notes yet.'))}
      ${section('Other facts / factoids', md(a.factoids_md) || placeholder('No factoids yet.'))}
      ${mediaSection(imgs, vids)}
      ${sourcesSection(a.sources)}
    `;
  }

  // ====== Helpers ======
  function section(title, html){ return `<div class="section"><h3>${escapeHtml(title)}</h3><div>${html}</div></div>`; }
  function placeholder(text){ return `<div class="muted">${escapeHtml(text)}</div>`; }
  function md(markdown){ if(!markdown) return ''; try { return window.marked?.parse(markdown) || escapeHtml(markdown); } catch { return escapeHtml(markdown); } }
  function mediaSection(imgs, vids){
    const parts=[]; if (imgs.length) parts.push(`<div class="section"><h3>Images</h3><div class="gallery">${imgs.map(src=>`<img src="${escapeAttr(src)}"/>`).join('')}</div></div>`);
    if (vids.length) parts.push(`<div class="section"><h3>Videos</h3>${vids.map(url=>`<div style=\"margin-bottom:8px\"><a href=\"${escapeAttr(url)}\" target=\"_blank\" rel=\"noopener\">${escapeHtml(url)}</a></div>`).join('')}</div>`);
    return parts.join('');
  }
  function sourcesSection(s){ if(!s) return ''; const items=(s||'').split(';').map(x=>x.trim()).filter(Boolean); if(!items.length) return ''; return `<div class="section"><h3>Sources</h3><ul>${items.map(x=>`<li class="muted">${escapeHtml(x)}</li>`).join('')}</ul></div>`; }
  function unique(arr){ return Array.from(new Set(arr)).sort(); }
  function fillSelect(select, values){ select.innerHTML = `<option value="">All</option>` + values.map(v=>`<option value="${escapeAttr(v)}">${escapeHtml(v)}</option>`).join(''); }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function escapeAttr(s){ return escapeHtml(s); }
  function sqlEscape(s){ return String(s).replace(/'/g, "''"); }

  // Lightweight CSV parser → array of objects (header-based)
  function csvToObjects(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    if (!lines.length) return [];
    const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
    const rows = [];
    for (let i=1;i<lines.length;i++){
      const cols = splitCsvLine(lines[i]);
      const obj = {}; headers.forEach((h,idx)=> obj[h] = (cols[idx]||'').trim());
      rows.push(normalizeRow(obj));
    }
    return rows;
  }
  function splitCsvLine(line){
    const out=[]; let cur=''; let inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch==='"') { if (inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
      else if (ch===',' && !inQ) { out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur); return out;
  }
  function normalizeRow(obj){
    const o={}; for (const k in obj){ o[k.trim().toLowerCase()] = obj[k]; }
    const lat = parseFloat(o.lat || o.latitude); const lon = parseFloat(o.lon || o.lng || o.longitude);
    return {
      id: o.id || slug(`${o.name||''}-${o.parish||''}`),
      name: (o.name||'').trim(),
      alt_names: (o.alt_names||'').trim(),
      town_village: (o.town_village||o.location||'').trim(),
      parish: (o.parish||'').trim(),
      lat: isFinite(lat)?lat:NaN,
      lon: isFinite(lon)?lon:NaN,
      status: cap(o.status||''),
      classification: cap((o.classification||o.class||'').replaceAll('/', ' / ')),
      summary: o.summary||'',
      history_md: o.history_md||'',
      architecture_md: o.architecture_md||o.structure_md||'',
      worship_clergy_md: o.worship_clergy_md||'',
      factoids_md: o.factoids_md||'',
      sources: o.sources||'',
      images: o.images||'',
      videos: o.videos||''
    };
  }
  function rowsToGeoJSON(rows){
    const feats = rows.filter(r=>isFinite(r.lat)&&isFinite(r.lon)).map(r=>({
      type: "Feature",
      geometry: { type: "Point", coordinates: [r.lon, r.lat] },
      properties: r
    }));
    return { type: "FeatureCollection", features: feats };
  }
  function cap(s){ if(!s) return ''; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
  function slug(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
});
</script>
<!-- Optional Markdown support for details panel (client-side only). Remove if you don't need it. -->
<script src="https://unpkg.com/marked/marked.min.js"></script>
</body>
</html>
